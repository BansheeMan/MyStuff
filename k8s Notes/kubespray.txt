1) Создать виртуалки, обновить, настроить dns ssh, отключить swap
Установить sudo apt update && sudo apt install -y python3 python3-pip

2)Клонируем Kubespray
git clone --branch v2.28.0 https://github.com/kubernetes-sigs/kubespray.git

3)Копируем шаблон инвентаря и редактируем
cp -r inventory/sample inventory/mycluster

Теперь редактируем файл inventory/mycluster/inventory

[kube_control_plane]
kubespray-master-1 ansible_host=192.168.100.65
kubespray-master-2 ansible_host=192.168.100.66
kubespray-master-3 ansible_host=192.168.100.67

[etcd:children]
kube_control_plane

[kube_node]
kubespray-worker-1 ansible_host=192.168.100.68
kubespray-worker-2 ansible_host=192.168.100.69

Проверка связи через Ansible
ansible -i inventory/mycluster/inventory.ini all -m ping

4)Создать виртуальное окружение и установить зависимости python
python3 -m venv ./kubespray-venv
source ./kubespray-venv/bin/activate
cd kubespray/
pip3 install -r requirements.txt


5)Правим k8s-cluster.yaml, если надо, я правил только kubeconfig_localhost, значение которого выставили в true

6) Запускаем плейбук ансибл
cd ~/kubespray/
ansible-playbook -b -v cluster.yml