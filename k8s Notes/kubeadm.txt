1)sudo swapoff -a
free -h

sudo nano /etc/fstab
–ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –µ—ë /dev/mapper/ubuntu--vg-swap_1 none swap sw 0 0

######################################################################################

2)
lsmod | grep br_netfilter
–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∑–Ω–∞—á–∏—Ç –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.
sudo modprobe br_netfilter
modprobe ‚Äî —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π —è–¥—Ä–∞.
br_netfilter ‚Äî –º–æ–¥—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å bridge-—Å–µ—Ç–µ–≤–æ–π —Ç—Ä–∞—Ñ–∏–∫ —á–µ—Ä–µ–∑ iptables
–¥–æ–±–∞–≤—å –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É
echo 'br_netfilter' | sudo tee /etc/modules-load.d/k8s.conf

sudo tee /etc/sysctl.d/kubernetes.conf > /dev/null <<EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
EOF

sudo sysctl --system
sysctl --system ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ .conf —Ñ–∞–π–ª—ã –∏–∑ /etc/sysctl.d/, /run/sysctl.d/ –∏ /usr/lib/sysctl.d/.

sudo sysctl net.bridge.bridge-nf-call-iptables
–î–æ–ª–∂–Ω–æ –±—ã—Ç—å = 1

–ï—Å–ª–∏ –≤–Ω–æ—Å–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
sudo systemctl restart containerd
sudo systemctl restart kubelet

######################################################################################

3)–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ Kubernetes
–ù–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö (–º–∞—Å—Ç–µ—Ä–∞ –∏ –≤–æ—Ä–∫–µ—Ä—ã) –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:
kubeadm ‚Äî —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞.
kubelet ‚Äî –∞–≥–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–∞–º–∏ –Ω–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ.
kubectl ‚Äî CLI –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∫–ª–∞—Å—Ç–µ—Ä–æ–º (—Ç–æ–ª—å–∫–æ –Ω–∞ master, –Ω–æ –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –≤–µ–∑–¥–µ).
containerd ‚Äî runtime –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤.

3.1  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ containerd

sudo apt update && sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release software-properties-common

–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:
apt update ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤.
apt install ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞:
apt-transport-https ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –ø–æ HTTPS.
ca-certificates ‚Äî –∫–æ—Ä–Ω–µ–≤—ã–µ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã.
curl ‚Äî —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤.
gnupg ‚Äî –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GPG-–∫–ª—é—á–∞–º–∏.
lsb-release ‚Äî —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ —Å–∏—Å—Ç–µ–º—ã.
software-properties-common ‚Äî —Ä–∞–±–æ—Ç–∞ —Å PPA-—Ä–µ–ø–∞–º–∏.

sudo apt install -y containerd

–°–æ–∑–¥–∞—ë–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥:
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml

–¢–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–º —Ñ–∞–π–ª, —á—Ç–æ–±—ã CRI –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª systemd:
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

sudo systemctl restart containerd
sudo systemctl enable containerd

3.2 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Kubernetes –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/kubernetes.gpg

echo "deb https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt update
sudo apt install -y kubelet kubeadm kubectl

–ó–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤–µ—Ä—Å–∏–∏, —á—Ç–æ–±—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
sudo apt-mark hold kubelet kubeadm kubectl

######################################################################################

4) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes –Ω–∞ –ø–µ—Ä–≤–æ–º master'–µ
–í—Å—ë –¥–µ–ª–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–¥–µ ‚Äî kubeadm-master-1.

sudo kubeadm init \
  --control-plane-endpoint "kubeadm-master-1" \
  --upload-certs \
  --pod-network-cidr=10.244.0.0/16

–ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:
--control-plane-endpoint "kubeadm-master-1"
‚Üí —ç—Ç–æ DNS-–∏–º—è –∏–ª–∏ IP-–∞–¥—Ä–µ—Å —Ç–≤–æ–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ (–≤ HA –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å IP LoadBalancer'–∞, –ø–æ–∑–∂–µ —Å–¥–µ–ª–∞–µ–º). –°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –∏–º—è –ø–µ—Ä–≤–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞.
--upload-certs
‚Üí –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ—Ç–æ–º —à–∞—Ä–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –º–µ–∂–¥—É master-–Ω–æ–¥–∞–º–∏.
--pod-network-cidr=10.244.0.0/16
‚Üí CIDR –¥–ª—è –ø–æ–¥–æ–≤. –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Å–µ—Ç–µ–π —Ç–∏–ø–∞ Flannel (–º–æ–∂–µ–º –ø–æ–∑–∂–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é CNI ‚Äî –æ–±—Å—É–¥–∏–º).


üìù  –°–æ—Ö—Ä–∞–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç!
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—ã –ø–æ–ª—É—á–∏—à—å:
–ö–æ–º–∞–Ω–¥—É –¥–ª—è kubeadm join –¥–ª—è –≤–æ—Ä–∫–µ—Ä–æ–≤.
–ö–æ–º–∞–Ω–¥—É kubeadm join ... --control-plane ... --certificate-key ... –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –º–∞—Å—Ç–µ—Ä–æ–≤.
‚úçÔ∏è –°–∫–æ–ø–∏—Ä—É–π –∏—Ö –≤ —Ñ–∞–π–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä:
mkdir -p $HOME/k8s-init/
kubeadm init ... > $HOME/k8s-init/output.log

–ß—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è kubectl –±–µ–∑ sudo:
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

######################################################################################

5) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å CNI (—Å–µ—Ç–µ–≤–æ–π –ø–ª–∞–≥–∏–Ω) (—É –Ω–∞—Å Flannel)
kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml

kubectl get nodes
–ï—Å–ª–∏ –≤—Å—ë –æ–∫, —Å—Ç–∞—Ç—É—Å –ø–æ–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ Ready.

–¢–æ–∫–µ–Ω—ã –∏ –∫–ª—é—á–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

You can now join any number of the control-plane node running the following command on each as root:

  kubeadm join kubeadm-master-1:6443 --token m74qvk.y23gj48rgkj8n64k \
        --discovery-token-ca-cert-hash sha256:a185bda0e544d7a9ba9beffb7259eee1dfd0119afee5da97f8c991e5a7a9a77d \
        --control-plane --certificate-key edd3476ded991e383fdf3ad78550529b0b05a59db98cae3b0bbed3ef401f74c6

Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
"kubeadm init phase upload-certs --upload-certs" to reload certs afterward.

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join kubeadm-master-1:6443 --token m74qvk.y23gj48rgkj8n64k \
        --discovery-token-ca-cert-hash sha256:a185bda0e544d7a9ba9beffb7259eee1dfd0119afee5da97f8c991e5a7a9a77d

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

–ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–ª kubeadm init --upload-certs, Kubernetes:
—Å–æ–∑–¥–∞–ª —Å–µ–∫—Ä–µ—Ç kubeadm-certs –≤ namespace kube-system
–Ω–æ –æ–Ω –∂–∏–≤—ë—Ç —Ç–æ–ª—å–∫–æ 2 —á–∞—Å–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚è≥

–ù–∞ kubeadm-master-1 –Ω—É–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä:
sudo kubeadm init phase upload-certs --upload-certs
–¢—ã –ø–æ–ª—É—á–∏—à—å –Ω–æ–≤—ã–π certificate-key, —Ç–∏–ø–∞:
1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef

–° –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥ –∫–æ—Ç–æ—Ä–∞—è –≤—ã—à–µ –ø–æ–¥–∫–ª—é—á–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞ –≤–æ—Ä–∫–µ—Ä—ã

–ï—Å–ª–∏ —Ä–æ–ª–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–∞ kubeadm-master-1 –≤—ã–ø–æ–ª–Ω–∏:
kubectl label node kubeadm-worker-1 node-role.kubernetes.io/worker=worker
kubectl label node kubeadm-worker-2 node-role.kubernetes.io/worker=worker
